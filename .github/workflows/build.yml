name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows x64 MSVC
          - os: ubuntu-latest
            name: Linux x64 GCC
          - os: macos-14
            name: macOS ARM64 Clang

    steps:
    - name: Checkout with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install NASM (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install nasm -y
        echo "C:\Program Files\NASM" >> $GITHUB_PATH

    - name: Install NASM (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get install -y nasm

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Test (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        .\build\Release\version_test.exe
        .\build\Release\ivf_format_test.exe --all
        .\build\Release\decode_test.exe --all

    - name: Test (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        ./build/version_test
        ./build/ivf_format_test --all
        ./build/decode_test --all